<!DOCTYPE html>
<html>
<!--
background page - Drag'n Download

Author : Yuki <paselan@gmail.com>
Date   : December 14, 2011
License: MIT License
-->
<head>
  <meta charset="UTF-8">
  <title></title>

  <script>
    var DDCtrl = {
      isIgnoredURL : function (url) {
        // TODO: 
        return /^chrome:/.test(url);
      },

      updateIcon : function (tab) {
        if (this.isIgnoredURL(tab.url))
          chrome.pageAction.hide(tab.id);
        else
          chrome.pageAction.show(tab.id);
      },

      toggle : function (tabId) {
        var self = this;
        var request = {
          type : "toggle"
        };
        chrome.tabs.sendRequest(tabId, request, function (response) {
          if (response.state.disabled)
            self.disable(tabId);
          else
            self.enable(tabId);
        });
      },

      enable : function (tabId) {
        chrome.pageAction.setIcon({"tabId":tabId, path:"main-32.png"});
      },

      disable : function (tabId) {
        chrome.pageAction.setIcon({"tabId":tabId, path:"main-gray-32.png"});
      }
    };

    chrome.extension.onRequest.addListener(function (request, sender, sendResponse) {
      var response = {};
      if (request.type === 'init') {
        DDCtrl.updateIcon(sender.tab);
        response.ignored = DDCtrl.isIgnoredURL(sender.tab.url);
      }
      sendResponse(response);
    });

    chrome.pageAction.onClicked.addListener(function (tab) {
      DDCtrl.toggle(tab.id);
    });

    chrome.tabs.onSelectionChanged.addListener(function (tabId) {
      chrome.tabs.get(tabId, function (tab) {
        DDCtrl.updateIcon(tab);
      });
    });

    chrome.tabs.getAllInWindow(null, function (tabs) {
      for (var i = 0; i < tabs.length; i++)
        DDCtrl.updateIcon(tabs[i]);
    });
  </script>
</head>
<body>
</body>
</html>
